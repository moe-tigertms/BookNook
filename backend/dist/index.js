import "dotenv/config";
import express from "express";
import cors from "cors";
import { clerkMiddleware, requireAuth } from "@clerk/express";
import { booksRouter } from "./routes/books.js";
import { checkoutsRouter } from "./routes/checkouts.js";
import { searchRouter } from "./routes/search.js";
import { authRouter } from "./routes/auth.js";
import { aiRouter } from "./routes/ai.js";
import { syncUser } from "./middleware/syncUser.js";
const app = express();
const PORT = process.env.PORT ?? 3001;
app.use(cors({ origin: process.env.FRONTEND_URL ?? "http://localhost:5173", credentials: true }));
app.use(express.json());
app.use(clerkMiddleware());
app.use("/api/auth", authRouter);
app.use("/api/books", requireAuth(), syncUser, booksRouter);
app.use("/api/checkouts", requireAuth(), syncUser, checkoutsRouter);
app.use("/api/search", requireAuth(), syncUser, searchRouter);
app.use("/api/ai", requireAuth(), syncUser, aiRouter);
app.get("/api/health", (_req, res) => res.json({ ok: true }));
app.use((err, _req, res, _next) => {
    console.error(err);
    res.status(500).json({ error: "Internal server error" });
});
app.listen(PORT, () => console.log(`Server running at http://localhost:${PORT}`));
